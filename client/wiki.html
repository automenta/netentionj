<!DOCTYPE html>
<html>
    <head>
        <title>Netention Wikipedia</title>
        <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div id="ProfileSelect"  class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">Profile</h4>
                    </div>
                    <div class="modal-body">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button id="ProfileSave" type="button" class="btn btn-primary">Save changes</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->


        <div id="mainmenu" class="container-fluid navbar-default">                        
            <div id="wikimenu">
                <button id="EditSelf"><i class="fa fa-users"></i></button>
            </div>
            <div id="context"></div>
        </div>
        <div id="wiki"></div>
        <div id="tagbar" class="container-fluid navbar-default">

        </div>

    </body>

    <script src="lib/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="lib/lodash/lodash.min.js" type="text/javascript"></script> 
    <script src="lib/underscore.string/2.3.3/underscore.string.min.js" type="text/javascript"></script> 
    <script src="lib/backbone.js/backbone-min.js" type="text/javascript"></script> 

    <script src="lib/setImmediate.js" type="text/javascript"></script> 
    <script src="lib/lunr/lunr.min.js"></script>
    <script src="/lib/graphlib.min.js" type="text/javascript"></script> 
    <script src="/lib/pouchdb/pouchdb-3.0.5.min.js"></script>
    <script src="/util/db.pouch.js" type="text/javascript"></script>
    <script src="/util/util.js" type="text/javascript"></script>

    <script src="lib/leaflet/leaflet.js"></script>
    <script src="lib/leaflet/Control.OSMGeocoder.js"></script>

    <script src="lib/pnotify/pnotify.custom.min.js" type="text/javascript"></script>
    <script src="lib/bootstrap/bootstrap.min.js"></script>

    <script src="netention.js" type="text/javascript"></script> 

    <script src="widget.object.js" type="text/javascript"></script>     
    <script src="widget.profile.js" type="text/javascript"></script>     
    <script src="widget.map.js" type="text/javascript"></script> 
    <script src="widget.wiki.js" type="text/javascript"></script> 

    <script src="connect.http.js" type="text/javascript"></script>
    <script src="client_configuration.js" type="text/javascript"></script> 

    <script src="lib/sockjs/sockjs-0.3.4.min.js"></script>
    <script src='lib/sockjs/vertxbus.min.js'></script>    
    <script src='connect.websocket.js'></script>    


    <script>
        var wiki;
        
        $(document).ready(function () {
            var router = {
                routes: {
                    'me': 'me', // #help
                    'wiki/:page': 'wiki',
                    'wiki/search/:query': 'wikisearch',
//                    'object/:id': 'showObject',
//                    'object/:id/focus': 'focus',
//                    'tag/:tag': 'tag',
//                    'tag/:tag/new': 'tagNew',
//                    //"new/with/tags/:t":     "newWithTags",
//                    'example': 'completeExample',
//                    'user/:userid': 'user',
//                    ':view': 'view',
//                    ':view/tag/:tag': 'viewTag',
//                    'read/*url': 'read'
//                            //"search/:query/:page":  "query"   // #search/kiwis/p7
                },
                me: function() {
                    selfEdit(true);
                },
                completeExample: function() {
                    commitFocus(exampleObject);
                },
                showObject: function(id) {
                    var x = $N.object[id];
                    if (x) {
                        newPopupObjectView(x);
                    }
                    else {
                        notify({
                            title: 'Unknown object',
                            text: id
                        });
                    }
                },
                wiki: function(page) {
                    wiki.gotoTag(page, false);
                },
                wikisearch: function(query) {
                    wiki.gotoTag(query, true);
                },
                viewTag: function(view, tag) {
                    $N.set('currentView', view);

                    var tf = new $N.nobject();
                    tf.addTag(tag);
                    $N.setFocus(tf);

                    //show sidebar
                    if (!$('#FocusEditWrap').is(':visible'))
                        $('#FocusEditToggleButton').click();
                },
                user: function(userid) {
                    $N.set('currentView', {view: 'user', userid: userid});
                },
                tagNew: function(tag) {
                    var n = new $N.nobject();
                    n.addTag(tag);
                    newPopupObjectEdit(n);
                },
                read: function(url) {
                    later(function() {
                        viewRead(url);
                    });
                }
            };
            
            
            netention(router);



            wiki = newWikiBrowser(function onSelected(e) {
                onWikiTagAdded($('#tagbar'), e);
            });
            wiki._gotoTag = wiki.gotoTag; //HACK
            wiki.gotoTag = function(page, search) {
                var r;
                if (search) {
                    r = 'wiki/search/' + page;
                }  
                else {
                    r = 'wiki/' + page;
                }
                $N.router.navigate(r, {trigger: true});
                wiki._gotoTag(page, search);
            };
            
            $('#wiki').html(wiki);
            $('.WikiBrowserHeader').children().detach().appendTo('#mainmenu #wikimenu');


            $N.once('bus.start', function () {

                bus.on('public', function (message) {

                    try {
                        var c = JSON.parse(message);
                        var m = '';
                        var t = $('#context');
                        t.empty();
                        for (var k in c.context) {
                            var count = parseInt(c.context[k]);

                            var label = k;
                            if (k.indexOf('/') != -1)
                                label = k.substring(k.lastIndexOf('/') + 1, k.length);

                            var l = $('<a href="#">' + label + '</a>');

                            l.css('font-size', 50.0 * Math.log(1 + count) + '%');
                            t.append(l, '&nbsp;');
                        }
                    }
                    catch (e) {
                        console.error('Unable to parse: ' + message);
                    }

                });

            });

            $N.once('session.start', function () {
                $('#EditSelf').click(function () {
                    selfEdit(!($('#ProfileSelect').is(':visible')));
                });
            });

        });



        function notify(x) {
            if (typeof x === "string")
                x = { title: x, text: '' };
            
            new PNotify(x);
            console.log(JSON.stringify(x));
        }

        function selfEdit(enable) {
            var ps = $('#ProfileSelect');
            var modal = $('#ProfileSelect .modal-body');
            if (enable) {
                ps.modal('show');
                if (modal.children().size() === 0) {
                    ps.on('shown.bs.modal', function (e) {
                        modal.html(newNewProfileWidget());
                    });
                }
            }
            else {
                ps.modal('hide');
            }
        }
        //originally from widget.profile.js
        function newNewProfileWidget(whenFinished) {
            var d = newDiv();

            var nameField = $('<input type="text" placeholder="Name"></input>');
            d.append(nameField).append('<br/>');


            var emailField = $('<input type="text" placeholder="E-Mail (optional)"></input>');
            d.append(emailField).append('<br/>');


            var extraProperties = configuration.newUserProperties;
            if (extraProperties) {
                var extraPropertyInputs = [];
                for (var i = 0; i < extraProperties.length; i++) {
                    var e = extraProperties[i];
                    var ep = $N.getProperty(e);
                    var en = ep ? ep.name : e;
                    var ei = $('<input type="text"/>');
                    d.append(en, ei, '<br/>');
                    extraPropertyInputs.push(ei);
                }
            }


            var locationEnabled = true;
            var locEnabled = $('<input type="checkbox" checked="true"/>');

            d.append('<br/>').append(locEnabled).append('Location Enabled').append('<br/>');

            var cm = $('<div id="SelfMap"/>').appendTo(d);

            /*var createButton = $('<button>Create User</button>');
             d.append('<br/>').append(createButton);*/

            var location = configuration.mapDefaultLocation;

            var lmap;
            later(function () {
                lmap = initLocationChooserMap('SelfMap', location, 7, true);
            });

            locEnabled.change(function () {
                locationEnabled = locEnabled.is(':checked');
                if (locationEnabled) {
                    cm.show();
                }
                else {
                    cm.hide();
                }
            });


            $('#ProfileSave').click(function () {
                var m = $N.myself();
                m.name = nameField.val();
                m.email = emailField.val();
                
                //TODO remove geolocation if disabled
                if (lmap.location)
                    m.geolocation = lmap.location();
                                    
                objTouch(m);

                $N.pub(m, function (e) {
                    notify('Error saving profile: ' + e);
                }, function () {
                    notify('Saved profile');
                });
                
                selfEdit(false);
            });

            nameField.val($N.myself().name);
            emailField.val($N.myself().email);

            return d;
        }

    </script> 
    <style>@import url("wiki.css");</style>
</html>
