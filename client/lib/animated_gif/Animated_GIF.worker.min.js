function NeuQuant(){function r(r,n,t){var e,a;for(v=r,l=n,h=t,p=new Array(g),e=0;g>e;e++)p[e]=new Array(4),a=p[e],a[0]=a[1]=a[2]=(e<<D+8)/g|0,H[e]=U/g|0,E[e]=0}function n(){for(var r=[],n=new Array(g),t=0;g>t;t++)n[p[t][3]]=t;for(var e=0,a=0;g>a;a++){var o=n[a];r[e++]=p[o][0],r[e++]=p[o][1],r[e++]=p[o][2]}return r}function t(){var r,n,t,e,a,o,i,u;for(i=0,u=0,r=0;g>r;r++){for(a=p[r],t=r,e=a[1],n=r+1;g>n;n++)o=p[n],o[1]<e&&(t=n,e=o[1]);if(o=p[t],r!=t&&(n=o[0],o[0]=a[0],a[0]=n,n=o[1],o[1]=a[1],a[1]=n,n=o[2],o[2]=a[2],a[2]=n,n=o[3],o[3]=a[3],a[3]=n),e!=i){for(q[i]=u+r>>1,n=i+1;e>n;n++)q[n]=r;i=e,u=r}}for(q[i]=u+z>>1,n=i+1;256>n;n++)q[n]=z}function e(){var r,n,t,e,a,o,i,p,g,z,T,U,B,P;for(A>l&&(h=1),s=30+(h-1)/3,U=v,B=0,P=l,T=l/(3*h),z=T/F|0,p=S,o=N,i=o>>W,1>=i&&(i=0),r=0;i>r;r++)J[r]=p*((i*i-r*r)*M/(i*i));for(g=A>l?3:l%y!==0?3*y:l%d!==0?3*d:l%m!==0?3*m:3*w,r=0;T>r;)if(t=(255&U[B+0])<<D,e=(255&U[B+1])<<D,a=(255&U[B+2])<<D,n=c(t,e,a),f(p,n,t,e,a),0!==i&&u(i,n,t,e,a),B+=g,B>=P&&(B-=l),r++,0===z&&(z=1),r%z===0)for(p-=p/s,o-=o/R,i=o>>W,1>=i&&(i=0),n=0;i>n;n++)J[n]=p*((i*i-n*n)*M/(i*i))}function a(r,n,t){var e,a,o,i,u,f,c;for(u=1e3,c=-1,e=q[n],a=e-1;g>e||a>=0;)g>e&&(f=p[e],o=f[1]-n,o>=u?e=g:(e++,0>o&&(o=-o),i=f[0]-r,0>i&&(i=-i),o+=i,u>o&&(i=f[2]-t,0>i&&(i=-i),o+=i,u>o&&(u=o,c=f[3])))),a>=0&&(f=p[a],o=n-f[1],o>=u?a=-1:(a--,0>o&&(o=-o),i=f[0]-r,0>i&&(i=-i),o+=i,u>o&&(i=f[2]-t,0>i&&(i=-i),o+=i,u>o&&(u=o,c=f[3]))));return c}function o(){return e(),i(),t(),n()}function i(){var r;for(r=0;g>r;r++)p[r][0]>>=D,p[r][1]>>=D,p[r][2]>>=D,p[r][3]=r}function u(r,n,t,e,a){var o,i,u,f,c,s,v;for(u=n-r,-1>u&&(u=-1),f=n+r,f>g&&(f=g),o=n+1,i=n-1,s=1;f>o||i>u;){if(c=J[s++],f>o){v=p[o++];try{v[0]-=c*(v[0]-t)/k|0,v[1]-=c*(v[1]-e)/k|0,v[2]-=c*(v[2]-a)/k|0}catch(l){}}if(i>u){v=p[i--];try{v[0]-=c*(v[0]-t)/k|0,v[1]-=c*(v[1]-e)/k|0,v[2]-=c*(v[2]-a)/k|0}catch(l){}}}}function f(r,n,t,e,a){var o=p[n],i=r/S;o[0]-=i*(o[0]-t)|0,o[1]-=i*(o[1]-e)|0,o[2]-=i*(o[2]-a)|0}function c(r,n,t){var e,a,o,i,u,f,c,s,v,l;for(s=~(1<<31),v=s,f=-1,c=f,e=0;g>e;e++)l=p[e],a=l[0]-r,0>a&&(a=-a),o=l[1]-n,0>o&&(o=-o),a+=o,o=l[2]-t,0>o&&(o=-o),a+=o,s>a&&(s=a,f=e),i=a-(E[e]>>T-D),v>i&&(v=i,c=e),u=H[e]>>P,H[e]-=u,E[e]+=u<<B;return H[f]+=Q,E[f]-=b,c}var s,v,l,h,p,g=256,y=499,d=491,m=487,w=503,A=3*w,z=g-1,D=4,F=100,T=16,U=1<<T,B=10,P=10,Q=U>>P,b=U<<B-P,x=g>>3,W=6,G=1<<W,N=x*G,R=30,C=10,S=1<<C,I=8,M=1<<I,j=C+I,k=1<<j,q=[],E=[],H=[],J=[];r.apply(this,arguments);var K={};return K.map=a,K.process=o,K}function channelizePalette(r){for(var n=[],t=0;t<r.length;t++){var e=r[t],a=(16711680&e)>>16,o=(65280&e)>>8,i=255&e;n.push([a,o,i,e])}return n}function dataToRGB(r,n,t){for(var e=0,a=n*t*4,o=[];a>e;)o.push(r[e++]),o.push(r[e++]),o.push(r[e++]),e++;return o}function componentizedPaletteToArray(r){for(var n=[],t=0;t<r.length;t+=3){var e=r[t],a=r[t+1],o=r[t+2];n.push(e<<16|a<<8|o)}return n}function processFrameWithQuantizer(n,t,e,a){for(var o=dataToRGB(n,t,e),i=new NeuQuant(o,o.length,a),u=i.process(),f=new Uint32Array(componentizedPaletteToArray(u)),c=t*e,s=new Uint8Array(c),v=0,l=0;c>l;l++)r=o[v++],g=o[v++],b=o[v++],s[l]=i.map(r,g,b);return{pixels:s,palette:f}}function processFrameWithDithering(r,n,t,e,a){var o=dataToRGB(r,n,t);if(null===a){var i=new NeuQuant(o,o.length,16),u=i.process();a=componentizedPaletteToArray(u)}var f,c=new Uint32Array(a),s=channelizePalette(a);return f="closest"===e?Dithering.Closest:"floyd"===e?Dithering.FloydSteinberg:Dithering.Bayer,pixels=f(o,n,t,s),{pixels:pixels,palette:c}}function run(r){var n=r.width,t=r.height,e=r.data,a=r.dithering,o=r.palette,i=r.sampleInterval;return a?processFrameWithDithering(e,n,t,a,o):processFrameWithQuantizer(e,n,t,i)}var Dithering=function(){"use strict";function r(r){return 0>r?0:r>255?255:r}function n(r,n,t,e,a){for(var o,i,u,f,c,s=195076,v=0,l=0;a>l;l++)c=e[l],o=r-c[0],i=n-c[1],u=t-c[2],f=o*o+i*i+u*u,s>f&&(v=l,s=f);return v}function t(t,e,a,i){for(var u,f,c,s,v,l=0,h=0,p=i.length,g=o,y=new Uint8Array(e*a),d=8,m=8,w=0;a>w;w++)for(var A=w%m,z=0;e>z;z++)s=g[z%d][A],u=r(t[l++]+s),f=r(t[l++]+s),c=r(t[l++]+s),v=n(u,f,c,i,p),y[h++]=v;return y}function e(r,t,e,a){for(var o,i,u,f=0,c=a.length,s=t*e,v=new Uint8Array(s),l=0;s>l;l++)o=r[f++],i=r[f++],u=r[f++],v[l]=n(o,i,u,a,c);return v}function a(t,e,a,o){for(var i,u,f,c,s,v,l=o.length,h=0,p=0,g=e-1,y=a-1,d=new Uint8Array(e*a),m=0;a>m;m++)for(var w=0;e>w;w++){i=r(t[h++]),u=r(t[h++]),f=r(t[h++]);{var A=n(i,u,f,o,l),z=o[A];z[3]}d[p]=A;var D=i-z[0],F=u-z[1],T=f-z[2];g>w&&(c=h+1,t[c++]+=7*D>>4,t[c++]+=7*F>>4,t[c++]+=7*T>>4),y>m&&(w>0&&(v=h-1+e,t[v++]+=3*D>>4,t[v++]+=3*F>>4,t[v++]+=3*T>>4),s=h+e,t[s++]+=5*D>>4,t[s++]+=5*F>>4,t[s++]+=5*T>>4,g>w&&(t[s++]+=D>>4,t[s++]+=F>>4,t[s++]+=T>>4)),p++}return d}var o=[[1,49,13,61,4,52,16,64],[33,17,45,29,36,20,48,32],[9,57,5,53,12,60,8,56],[41,25,37,21,44,28,40,24],[3,51,15,63,2,50,14,62],[35,19,47,31,34,18,46,30],[11,59,7,55,10,58,6,54],[43,27,39,23,42,26,38,22]];return{Bayer:t,Closest:e,FloydSteinberg:a}}();self.onmessage=function(r){var n=r.data,t=run(n);postMessage(t)};